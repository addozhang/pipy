---
title: 概念
---

# 流

Pipy 是一个 “_流处理器_”，它将 *流* 作为输入和输出。但与人们通常认为的 _流_ 不同，Pipy 中的流是由 **事件（events）** 而不是单个数据字节组成。有四种类型的事件：

* `Data`
* `MessageStart`
* `MessageEnd`
* `StreamEnd`

来自网络的流由一系列的 **Data** 事件组成，每个事件包含了从 TCP 连接接收的一块字节。

Pipy 处理输入流中的事件：有些被转换，有些被丢弃，也有些新的事件加入。Pipy 内部那些新生成的事件还包含了除 **Data** 以外的类型： **MessageStart**、**MessageEnd** 和 **StreamEnd**。这些非数据事件作为 “_标记（markers）_” 使用，为承载业务逻辑的原始字节流提供更高级的语义。

最终，经过处理后所有留在流中的事件通过网络被发回客户端。此时，除 **Data** 以外的所有其他事件都被丢弃。

# 过滤器和管道

了解管道（Pipeline）的最佳方法是将其想象成 [_Unix pipelines_](https://en.wikipedia.org/wiki/Pipeline_(Unix))。唯一与 Unix 管道不同的是 Pipy 处理的是事件流而不是字节流。

Pipy 内部的 **过滤器（Filter）** 链处理传入的流。每个过滤器有点像一个小型 Unix 进程，从其输入（stdin）读取并将结果写到输出（stdout），一个过滤器的输出是下一个过滤器的输入。

过滤器链称作 **管道**。按其输入源的类型分成 4 类：

## 端口管道

当有 TCP 连接接入时，会创建 **端口管道（Port pipeline）**。它从网络端口读取并处理 **Data** 事件，然后将结果发回客户端。就像 HTTP 中的 *_请求响应_* 通信模型，管道的输入就是请求，输出就是那响应。可以这么认为：每个接入的连接都有一个关联的*端口管道*，用于处理该连接上发生的通信。

## 定时器管道

**定时器管道（Timer Pipeline）** 定期得到一对 **MessageStart** 和 **MessageEnd** 事件作为其唯一输入。不论内部的过滤器如何处理，所有的输出都会被丢弃。这种管道可以用于执行类似 [_cron job_](https://en.wikipedia.org/wiki/Cron) 的任务。

## 信号管道

当信号发送到 Pipy 进程时会创建 **信号管道**。它将一对 **MessageStart** 和 **MessageEnd** 事件作为其唯一输入。不论内部的过滤器如何处理，所有的输出都会被丢弃。这种管道在需要响应某种信号时很有用。

## 子管道

**子管道**是可以使用**联合过滤器（joint filter）**连接到其他管道。最基本的联合过滤器是 **link**。它从管道中的前一个过滤器接收事件，将它们发送到子管道进行处理并将该子管道的输出发送给下一个过滤器。

*子管道*和*联合过滤器*就像程序设计里子程序调用过程中的*被调用方*和*调用方*。联合过滤器的输入是子程序的参数，联合过滤器的输出是它的返回值。

与子管道不同，其他类型的管道 **端口管道**、**定时器管道** 和 **信号管道** 不能被联合过滤器在内部 **_调用_**。它们只能从外部通过接入的连接、定时器或者信号启动。我们称这些管道为**起始管道（root pipelines）**。

# 模块

**模块** 是包含定义了一系列**管道布局**脚本的 PipyJS 源文件。

**管道布局**表明管道包含了哪些过滤器及其顺序。在模块中配置管道布局并不会立即创建管道。此时它只是定义了管道的内容，只有在运行时处理输入的时候才会创建管道。尽管有些情况下含义很明显，为了简洁我们使用术语 “*管道*”来表示“*管道布局*”。

由于“*模块*”和“*过滤器*”是一对一的，两个术语可以互换使用。

# 上下文

**上下文（Context）** 是附加到管道的一组变量，脚本使用它来管理管道的当前状态。

Pipy 模块中的每个管道都使用相同的变量集。换句话说，同一模块的所有管道间上下文具有相同的*形态*，不同的模块的上下文形态不同。当启动 Pipy 模块时，要做的第一件事是定义上下文的*形态*，就是其拥有哪些变量以及变量的初始值。

虽然同一模块的所有管道有完全相同的上下文变量集，但每个管道的变量值是彼此隔离的，或者说每个管道都有其自己的“*状态*”。

模块的脚本将上下文变量作为**全局变量**使用，意味着脚本的任何位置都可以访问这些变量。

经验丰富的程序员来说可能会感觉怪异。因为*全局变量*通常意味着它们是全局唯一的，始终只有一组。而在 Pipy 中，我们可以有多组变量（也成为上下文），具体数量取决于端口管道的数量。如果熟悉多线程编程的概念，可以把**上下文**理解成 [*TLS（线程本地存储）*](https://en.wikipedia.org/wiki/Thread-local_storage)，不同的*线程*可以有不同状态的*全局变量*。或者就 Pipy 来说，*上下文变量*在不同*管道*间的状态可以不同。

我们可以互换使用术语“*上下文变量*”和“*全局变量*”。